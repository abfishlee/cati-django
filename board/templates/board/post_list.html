<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>파이썬 모델 기반 게시판</title>
    <!-- 외부 라이브러리 로드 (CSS & JS) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.js"></script>
    <!-- 커스텀 스타일 정의 -->
    <style>
        body { font-family: 'Inter', sans-serif; /* 웹페이지 기본 폰트 설정 */ }
        .ag-theme-alpine { 
            --ag-header-background-color: #f8fafc; /* AG Grid 헤더 배경색 */
            --ag-row-hover-color: #f1f5f9; /* AG Grid 행에 마우스를 올렸을 때 배경색 */
        }
        .modal { 
            transition: opacity 0.25s ease; /* 모달창이 나타나고 사라질 때 부드러운 애니메이션 효과 */
        }
        body.modal-active { 
            overflow-y: hidden; /* 모달이 열렸을 때 배경 스크롤을 막음 */
        }
        /* --- AG Grid 페이지네이션 반응형 스타일 --- */

        /* 모바일에서 AG Grid 컴팩트 모드 */
        @media (max-width: 640px) {
            /* 테마 전역 축소 */
            .ag-theme-alpine {
                --ag-font-size: 11px;     /* 기본 13px → 11px */
                --ag-grid-size: 2px;      /* 셀 padding 스케일 다운 */
                --ag-icon-size: 12px;     /* 아이콘 크기 축소 */
                --ag-header-height: 32px; /* 헤더 높이 축소 (선택) */
                --ag-row-height: 32px;    /* 행 높이 축소 (선택) */
            }

            /* 페이지네이션 패널 간격 줄이기 */
            .ag-theme-alpine .ag-paging-panel {
                gap: 4px;
                padding: 4px 6px;
                flex-wrap: wrap;
            }

            /* 모바일에선 행 요약/페이지 사이즈 셀렉터 숨김 (공간 절약) */
            .ag-theme-alpine .ag-paging-row-summary-panel,
            .ag-theme-alpine .ag-paging-page-size {
                display: none !important;
            }

            /* 버튼 여백/폰트 축소 */
            .ag-theme-alpine .ag-paging-button,
            .ag-theme-alpine .ag-button {
                padding: 2px 6px;
                font-size: 11px;
                min-height: 24px;
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- 메인 컨텐츠 영역 -->
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <!-- 페이지 헤더 -->
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-gray-900">Django 모델 게시판</h1>
            <p class="mt-2 text-lg text-gray-600">AG Grid와 Tailwind CSS 활용</p>
        </header>

        <!-- 게시판 그리드가 위치할 카드 UI -->
        <div class="bg-white rounded-xl shadow-md overflow-hidden">
            <div class="p-6">
                <div class="flex justify-end mb-4">
                    <button id="addPostBtn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition">새 글 작성</button>
                </div>
                <!-- AG Grid 라이브러리가 이 div를 실제 표(Grid)로 변환합니다. -->
                <div id="myGrid" class="ag-theme-alpine" style="height: 600px; width: 100%;"></div>
            </div>
        </div>
    </div>
    
    <!-- 게시글 작성/수정/조회 모달 (팝업창) -->
    <!-- 초기 상태: opacity-0(투명), pointer-events-none(클릭불가), z-50(매우 높은 z-index로 다른 요소 위에 표시) -->
    <div id="postModal" class="modal pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center opacity-0 z-50">
        <!-- 모달 뒷배경 (반투명 검은색) -->
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <!-- 모달 본문 컨테이너 (z-[51]로 뒷배경보다 한 단계 위에 표시) -->
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded-xl shadow-lg z-[51] overflow-y-auto">
            <div class="modal-content py-4 text-left px-6">
                <!-- 모달 헤더 (제목, 닫기 버튼) -->
                <div class="flex justify-between items-center pb-3 border-b">
                    <p id="modalTitle" class="text-2xl font-bold"></p>
                    <div id="modalClose" class="cursor-pointer z-50 p-2">
                        <svg class="fill-current text-black" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0.0 0 18 18"><path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path></svg>
                    </div>
                </div>
                <!-- 게시글 입력 폼 -->
                <form id="postForm" class="mt-4">
                    <!-- Django의 CSRF(Cross-Site Request Forgery) 공격 방지 토큰. form 제출 시 반드시 필요합니다. -->
                    {% csrf_token %}
                    <!-- 수정/삭제 시 사용할 게시글의 ID를 저장하는 숨겨진 필드 -->
                    <input type="hidden" id="postId">
                    <!-- 입력 필드: 제목, 작성자, 내용 -->
                    <div class="mb-4"><label for="title" class="block text-sm font-bold mb-2">제목</label><input type="text" id="title" class="w-full px-3 py-2 border rounded-lg" required></div>
                    <div class="mb-4"><label for="author" class="block text-sm font-bold mb-2">작성자</label><input type="text" id="author" class="w-full px-3 py-2 border rounded-lg" required></div>
                    <div class="mb-4"><label for="content" class="block text-sm font-bold mb-2">내용</label><textarea id="content" rows="5" class="w-full px-3 py-2 border rounded-lg" required></textarea></div>
                    <!-- 버튼 영역: 삭제, 저장/수정 -->
                    <div id="modal-actions" class="flex items-center justify-end pt-4 border-t">
                        <button id="deleteBtn" type="button" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 mr-2">삭제</button>
                        <button id="saveBtn" type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">저장</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
    // --- 공통 유틸: CSRF 토큰 ---
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
        for (const c of document.cookie.split(";")) {
            const cookie = c.trim();
            if (cookie.substring(0, name.length + 1) === (name + "=")) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
            }
        }
        }
        return cookieValue;
    }

    // --- 엔드포인트 상수화 ---
    const LIST_URL   = "{% url 'board:posts_api' %}";
    const CREATE_URL = "{% url 'board:create_post_api' %}";
    const DETAIL_URL = (id) => `${LIST_URL}${LIST_URL.endsWith('/') ? '' : '/'}${id}/`;

    // --- 요소/상태 ---
    const gridDiv = document.querySelector('#myGrid');
    const modal = document.getElementById('postModal');
    const modalClose = document.getElementById('modalClose');
    const addPostBtn = document.getElementById('addPostBtn');
    const postForm = document.getElementById('postForm');
    const modalTitle = document.getElementById('modalTitle');
    const postIdInput = document.getElementById('postId');
    const titleInput = document.getElementById('title');
    const authorInput = document.getElementById('author');
    const contentInput = document.getElementById('content');
    const saveBtn = document.getElementById('saveBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    let gridApi;



    // --- AG Grid 컬럼/옵션 ---
    const columnDefs = [
        { headerName: "ID", field: "id", width: 80, sortable: true },
        { headerName: "제목", field: "title", flex: 2, sortable: true, filter: true },
        { headerName: "작성자", field: "author", flex: 1, sortable: true },
        {
        headerName: "생성일", field: "created_at", flex: 1, sortable: true,
        valueFormatter: p => p.value ? new Date(p.value).toLocaleString('ko-KR') : ''
        },
        {
        headerName: "관리", field: "id", width: 180, sortable: false, filter: false,
        cellRenderer: params => `
            <button onclick="handleEdit(${params.value})" class="bg-green-500 text-white text-sm py-1 px-2 rounded hover:bg-green-600">수정</button>
            <button onclick="handleView(${params.value})" class="bg-gray-500 text-white text-sm py-1 px-2 rounded hover:bg-gray-600 ml-1">보기</button>
        `
        }
    ];

    const gridOptions = {
        columnDefs,
        rowData: [], // 초기값 명시
        pagination: true,
        paginationPageSize: 15,
        // 15를 셀렉터에 포함시키거나, 셀렉터 자체를 끄고 싶으면 false로
        paginationPageSizeSelector: [15, 20, 50, 100],
        // paginationPageSizeSelector: false,

        onGridReady: (params) => {
            gridApi = params.api;
            applyResponsivePaging();
            fetchData();
            // 리사이즈 대응 (디바운스)
            let t;
            window.addEventListener('resize', () => {
                clearTimeout(t);
                t = setTimeout(applyResponsivePaging, 150);
            });
        }
    };    

    // gridOptions 생성 직후에 추가
    const applyResponsivePaging = () => {
        const isMobile = window.innerWidth < 640; // tailwind 'sm' 기준
        gridApi.setGridOption('paginationPageSizeSelector', isMobile ? false : [15, 20, 50, 100]);
        // 필요하면 행수도 모바일 뷰에 맞게 자동 조정
        // gridApi.setGridOption('paginationAutoPageSize', isMobile ? true : false);
    };

    const fetchData = async () => {
        if (!gridApi) return;

        // v34: overlay 대신 loading 옵션 사용
        gridApi.setGridOption('loading', true);

        try {
            const res = await fetch(LIST_URL);
            const ct = res.headers.get('content-type') || '';
            console.log('[LIST] status:', res.status, 'content-type:', ct);

            if (!res.ok) {
            const text = await res.text().catch(() => '(body read failed)');
            console.error('[LIST] not ok:', res.status, text);
            throw new Error(`서버 응답 실패: ${res.status}`);
            }

            if (!ct.includes('application/json')) {
            const text = await res.text().catch(() => '(body read failed)');
            console.error('[LIST] unexpected content-type. raw body:', text);
            throw new Error('목록 응답이 JSON이 아닙니다');
            }

            let data;
            try {
            data = await res.json();
            } catch (e) {
            console.error('[LIST] JSON parse error:', e);
            throw new Error('목록 응답 JSON 파싱 실패');
            }

            if (!Array.isArray(data)) {
            console.error('[LIST] data is not an array:', data);
            throw new Error('목록 데이터 형식이 배열이 아닙니다');
            }

            // v34: setRowData → setGridOption('rowData', ...)
            gridApi.setGridOption('rowData', data);
        } catch (err) {
            console.error('데이터 로딩 중 에러:', err);
            // 실패 시 빈 데이터로 표시(선택)
            gridApi.setGridOption('rowData', []);
            alert('데이터를 불러오는 데 실패했습니다. 개발자 콘솔을 확인해주세요.');
        } finally {
            gridApi.setGridOption('loading', false);
        }
    };         

    // --- 모달 열고닫기 ---
    const openModal = () => {
        modal.classList.remove('opacity-0', 'pointer-events-none');
        document.body.classList.add('modal-active');
    };
    const closeModal = () => {
        modal.classList.add('opacity-0', 'pointer-events-none');
        document.body.classList.remove('modal-active');
    };

    // --- 전역에서 호출될 핸들러(AG Grid cellRenderer에서 사용) ---
    window.handleEdit = async (id) => {
        const res = await fetch(DETAIL_URL(id));
        const post = await res.json();
        setupModalForEdit(post);
    };
    window.handleView = async (id) => {
        const res = await fetch(DETAIL_URL(id));
        const post = await res.json();
        setupModalForView(post);
    };

    // --- 모달 모드 세팅 ---
    const setupModalForCreate = () => {
        postForm.reset();
        postIdInput.value = '';
        modalTitle.textContent = '새 글 작성';
        saveBtn.textContent = '저장';
        deleteBtn.classList.add('hidden');
        saveBtn.classList.remove('hidden');
        [titleInput, authorInput, contentInput].forEach(i => i.readOnly = false);
        openModal();
    };

    const setupModalForEdit = (post) => {
        postIdInput.value = post.id;
        titleInput.value = post.title;
        authorInput.value = post.author;
        contentInput.value = post.content;
        modalTitle.textContent = '글 수정';
        saveBtn.textContent = '수정';
        deleteBtn.classList.remove('hidden');
        saveBtn.classList.remove('hidden');
        [titleInput, authorInput, contentInput].forEach(i => i.readOnly = false);
        openModal();
    };

    const setupModalForView = (post) => {
        postIdInput.value = post.id;
        titleInput.value = post.title;
        authorInput.value = post.author;
        contentInput.value = post.content;
        modalTitle.textContent = '글 상세 보기';
        deleteBtn.classList.add('hidden');
        saveBtn.classList.add('hidden');
        [titleInput, authorInput, contentInput].forEach(i => i.readOnly = true);
        openModal();
    };

    // --- 저장/수정 ---
    const handleFormSubmit = async (e) => {
        e.preventDefault();
        const id = postIdInput.value;
        const isCreating = !id;
        const url = isCreating ? CREATE_URL : DETAIL_URL(id);
        const method = isCreating ? 'POST' : 'PUT';

        try {
        const res = await fetch(url, {
            method,
            headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
            title: titleInput.value,
            author: authorInput.value,
            content: contentInput.value
            })
        });
        if (!res.ok) {
            const text = await res.text();
            console.error('저장/수정 실패:', res.status, text);
            alert('저장/수정 실패');
            return;
        }
        closeModal();
        fetchData();
        } catch (err) {
        console.error('폼 제출 중 에러:', err);
        alert('요청 중 오류가 발생했습니다.');
        }
    };

    // --- 삭제 ---
    const handleDelete = async () => {
        const id = postIdInput.value;
        if (!id) return;
        if (!confirm('정말로 이 글을 삭제하시겠습니까?')) return;

        try {
        const res = await fetch(DETAIL_URL(id), {
            method: 'DELETE',
            headers: { 'X-CSRFToken': getCookie('csrftoken') }
        });
        if (res.status === 204) {
            closeModal();
            fetchData();
        } else {
            const text = await res.text();
            console.error('삭제 실패:', res.status, text);
            alert('삭제 실패');
        }
        } catch (err) {
        console.error('삭제 중 에러:', err);
        alert('요청 중 오류가 발생했습니다.');
        }
    };

    // --- 이벤트 바인딩 ---
    addPostBtn.addEventListener('click', setupModalForCreate);
    modalClose.addEventListener('click', closeModal);
    modal.querySelector('.modal-overlay').addEventListener('click', closeModal);
    postForm.addEventListener('submit', handleFormSubmit);
    deleteBtn.addEventListener('click', handleDelete);

    // --- AG Grid 부트스트랩 ---
    agGrid.createGrid(gridDiv, gridOptions);
    });
</script>
</body>
</html>

